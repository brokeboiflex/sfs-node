import e from"fs";import r from"path";import t from"check-disk-space";import{createHash as n}from"crypto";import{v4 as i}from"uuid";import{dotExtensionToCategotry as o}from"sfs-file-type";import{fileTypeFromBuffer as u}from"file-type";function s(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}function a(a){var c=a.publicFolder,l=a.mask,f=a.getFileById,h=a.getFileByHash,d=a.createFile,m=a.logger,v=void 0===m?void 0:m,p=a.uid,y=void 0===p?i:p,P=a.allowDuplicates,F=void 0!==P&&P,w=function(e){return(l.endsWith("/")?l:l+"/")+e},S=function(e){try{return Promise.resolve(s(function(){return Promise.resolve(f(e)).then(function(e){var t=e.name;return{filePath:r.join(c,e.hash+e.extension),fileName:t}})},function(e){v&&v(e,"error")}))}catch(e){return Promise.reject(e)}};return{resolveFilePath:S,idToUrl:w,urlToId:function(e){return l.endsWith("/")?e.replace(l,""):e.replace(l+"/","")},saveFile:function(t,i,a){void 0===i&&(i="/");try{return void 0===a&&(a=y()),Promise.resolve(s(function(){function s(){var n=r.join(c,f+m);return Promise.resolve(h(f)).then(function(r){function u(){if(!r||i!==r.path||F){var t=(null==r?void 0:r.size)||e.statSync(n).size,u=(null==r?void 0:r.type)||o(m),s=Date.now();return Promise.resolve(d({id:a,name:l,extension:m,hash:f,size:t,type:u,last_modified:s,path:i,publishedAt:s})).then(function(e){return e.url=w(e.id),e})}return v&&v("File already exists at this location","error"),r.url=w(r.id),r}var s=function(){if(!r)return v&&v("SFS: Saving file","success"),Promise.resolve(t.mv(n)).then(function(){});v&&v("SFS: File already uploaded","info")}();return s&&s.then?s.then(u):u()})}var l=decodeURI(t.name),f=n("sha256").update(t.data).digest("hex"),m="",p=r.extname(l),y=function(){if(!p)return Promise.resolve(u(t.data)).then(function(e){e&&(m="."+e.ext)});m=p}();return y&&y.then?y.then(s):s()},function(e){throw v&&v("Upload error","error"),new Error(e)}))}catch(e){return Promise.reject(e)}},deleteFileByHash:function(t){try{try{var n=e.readdirSync(c).find(function(e){return e.split(".")[0]===t});if(!n)throw new Error("File with hash "+t+" not found in "+c);var i=r.join(c,n);e.unlinkSync(i)}catch(e){throw new Error(e)}return Promise.resolve()}catch(e){return Promise.reject(e)}},deleteFileById:function(r){try{return Promise.resolve(s(function(){return Promise.resolve(S(r)).then(function(r){e.unlinkSync(r.filePath)})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}},getDiskUsage:function(e,r){try{return Promise.resolve(t(c))}catch(e){return Promise.reject(e)}}}}export{a as default};
//# sourceMappingURL=index.esm.js.map
