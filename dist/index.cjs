var e=require("fs"),r=require("path"),t=require("check-disk-space"),n=require("crypto"),i=require("uuid"),o=require("sfs-file-type"),u=require("file-type");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l=/*#__PURE__*/a(e),c=/*#__PURE__*/a(r),s=/*#__PURE__*/a(t);function f(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}module.exports=function(e){var r=e.publicFolder,t=e.mask,a=e.getFileById,d=e.getFileByHash,h=e.createFile,v=e.logger,m=void 0===v?void 0:v,y=e.uid,p=void 0===y?i.v4:y,P=e.allowDuplicates,F=void 0!==P&&P,w=function(e){return(t.endsWith("/")?t:t+"/")+e},g=function(e){try{return Promise.resolve(f(function(){return Promise.resolve(a(e)).then(function(e){var t=e.name;return{filePath:c.default.join(r,e.hash+e.extension),fileName:t}})},function(e){m&&m(e,"error")}))}catch(e){return Promise.reject(e)}};return{resolveFilePath:g,idToUrl:w,urlToId:function(e){return t.endsWith("/")?e.replace(t,""):e.replace(t+"/","")},saveFile:function(e,t,i){void 0===t&&(t="/");try{return void 0===i&&(i=p()),Promise.resolve(f(function(){function a(){var n=c.default.join(r,f+v);return Promise.resolve(d(f)).then(function(r){function u(){if(!r||t!==r.path||F){var e=(null==r?void 0:r.size)||l.default.statSync(n).size,u=(null==r?void 0:r.type)||o.dotExtensionToCategotry(v),a=Date.now();return Promise.resolve(h({id:i,name:s,extension:v,hash:f,size:e,type:u,last_modified:a,path:t,publishedAt:a})).then(function(e){return e.url=w(e.id),e})}return m&&m("File already exists at this location","error"),r.url=w(r.id),r}var a=function(){if(!r)return m&&m("SFS: Saving file","success"),Promise.resolve(e.mv(n)).then(function(){});m&&m("SFS: File already uploaded","info")}();return a&&a.then?a.then(u):u()})}var s=decodeURI(e.name),f=n.createHash("sha256").update(e.data).digest("hex"),v="",y=c.default.extname(s),p=function(){if(!y)return Promise.resolve(u.fileTypeFromBuffer(e.data)).then(function(e){e&&(v="."+e.ext)});v=y}();return p&&p.then?p.then(a):a()},function(e){throw m&&m("Upload error","error"),new Error(e)}))}catch(e){return Promise.reject(e)}},deleteFileByHash:function(e){try{try{var t=l.default.readdirSync(r).find(function(r){return r.split(".")[0]===e});if(!t)throw new Error("File with hash "+e+" not found in "+r);var n=c.default.join(r,t);l.default.unlinkSync(n)}catch(e){throw new Error(e)}return Promise.resolve()}catch(e){return Promise.reject(e)}},deleteFileById:function(e){try{return Promise.resolve(f(function(){return Promise.resolve(g(e)).then(function(e){l.default.unlinkSync(e.filePath)})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}},getDiskUsage:function(e,t){try{return Promise.resolve(s.default(r))}catch(e){return Promise.reject(e)}}}};
//# sourceMappingURL=index.cjs.map
